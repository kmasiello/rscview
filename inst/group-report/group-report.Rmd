---
title: "Group Report"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    css: custom.css
    theme:
      version: 4
      fg: "#4C8187"
      bg: "#fff"
editor_options: 
  chunk_output_type: console
---

```{r packages, include=FALSE}
library(rscview)
library(flexdashboard)
library(connectapi)
library(tidyverse)
library(lubridate)
library(DT)
library(reactable)
```

```{r check_envvars, include=FALSE}
check_envvars()
```

```{r get_users_tbl, include=FALSE}
conn <- 
  connectapi::connect(
    host = Sys.getenv("CONNECT_SERVER"),
    api_key = Sys.getenv("CONNECT_API_KEY")
  )

groups_tbl <- connectapi::get_groups(src = conn, limit = Inf)

grp_mbrs_tbl <- groups_tbl %>% transpose() %>% 
  map_dfr(~get_group_members(conn, .x$guid) %>% mutate(group_name = .x$name)) %>% 
  select(-created_time, -updated_time, -active_time, -confirmed, -locked, -guid)
  

```


```{r}
group_count <- nrow(groups_tbl)
```

```{r}
groups_summary <- grp_mbrs_tbl %>% group_by(group_name) %>% 
   summarise("Number of Members" = n()) 
```


Row 
-----------------------------------------------------------------------

### Number of Groups

```{r}
valueBox(group_count)
```

### Groups

```{r}
gt::gt(groups_summary)
```


Row{.tabset .tabset-fade}
-------------------------------------
   
### Connect Admin
```{r}
make_table <- function(x) {
  reactable(
  filter(grp_mbrs_tbl, group_name == x), searchable = TRUE, highlight = TRUE,
  filterable = TRUE, width = "100%"
  )
}
make_table("Connect Admin")

```

### Default
```{r}
make_table("Default")
```

### Developer
```{r}

make_table("Developer")
```

### Solutions Engineer
```{r}
make_table("Solutions Engineer")
```

### Staging 
```{r}
make_table("Staging")
```

### Test Role
```{r}
make_table("Test Role")
```

### User to Group info
```{r}
#what groups is a user in
reactable(
  grp_mbrs_tbl, searchable = TRUE, highlight = TRUE,
  filterable = TRUE, width = "100%"
  )
```

