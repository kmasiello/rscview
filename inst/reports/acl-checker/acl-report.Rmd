---
title: "ACL Report"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    css: custom.css
    theme:
      version: 4
      fg: "#4C8187"
      bg: "#fff"
editor_options: 
  chunk_output_type: console
---

```{r packages, include=FALSE}
library(flexdashboard)
library(connectapi)
library(dplyr)
library(stringr)
library(gt)
```

```{r check_envvars, include=FALSE}
# check_envvars()
```


```{r get_content_tbl, include=FALSE}
conn <- 
  connectapi::connect(
    server = Sys.getenv("CONNECT_SERVER"),
    api_key = Sys.getenv("CONNECT_API_KEY")
  )

# Requires connectapi version 0.1.0.9033+ to get expected content
content_tbl <- connectapi::get_content(src = conn, limit = Inf)
```

```{r}
df <- 
  content_tbl %>%
  dplyr::select(guid, access_type, content_category, app_mode) %>%
  dplyr::mutate(content_category = ifelse(content_category == "", "Unknown", content_category)) %>%
  dplyr::mutate(content_category = stringr::str_to_title(content_category)) %>%
  dplyr::mutate(access_type = dplyr::case_when(
    access_type == "acl" ~ "ACL",
    access_type == "all" ~ "All",
    access_type == "logged_in" ~ "Logged In",
    TRUE ~ access_type
  )) %>%
  dplyr::mutate(content_category = ifelse(content_category == "Unknown", "", paste0(content_category, "-"))) %>%
  dplyr::mutate(app_mode = tolower(paste0(content_category, app_mode))) %>%
  dplyr::group_by(access_type, app_mode) %>%
  dplyr::summarize(Count = n(), .groups = "drop") %>%
  dplyr::arrange(access_type, desc(Count)) %>%
  dplyr::group_by(access_type) %>%
  dplyr::mutate(Pct = Count / sum(Count)) %>%
  dplyr::ungroup()

df %>% 
  gt::gt(rowname_col = "app_mode", groupname_col = "access_type") %>%
  gt::tab_header(
    title = "Sharing Settings",
    subtitle = "RStudio Connect Server Content Audit"
  ) %>%
  gt::cols_width(
    app_mode ~ gt::px(150),
    Count ~ gt::px(100),
    Pct ~ gt::px(100)
  ) %>%
  gt::fmt_integer(columns = Count) %>%
  gt::fmt_percent(columns = Pct, decimals = 0) %>%
  gt::opt_all_caps() %>%
  gt::text_transform(
    locations = cells_body(columns = Pct),
    fn = function(x) ifelse(x == "0%", "<1%", x)
  ) %>%
  gt::row_group_order(c("All", "Logged In", "ACL"))
```

